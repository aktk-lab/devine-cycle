<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ç¥ã€…ã®å·¡è·¯ â€“ The Divine Cycle Pro (Lux ver.)</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0b10">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
/* ===== Theme tokens ===== */
:root{
  --bg:#0b0b10; --panel:#12141c; --text:#e9eaee; --sub:#a2a6ad; --edge:#ffffff1f;
  --accent:#8ab4f8; --accent2:#7cf0ff;
  --cardW:86px; --cardH:126px;
  --front:#fff; --frontText:#121212;

  /* Back design colors (Night) */
  --back-a:#0e1737; --back-b:#0a1128; --back-c:#081021;
  --orn:#6aa9ff;       /* ornaments */
  --g1:#182544; --g2:#1b2d52; --g3:#0f1b38;
}
:root.gold{
  --bg:#0f0a04; --panel:#171108; --text:#fff6e5; --sub:#dbcaa1; --edge:#f8e5a533;
  --accent:#ffd873; --accent2:#ffe8a6;
  --front:#fffaf0; --frontText:#332208;

  /* Back design colors (Gold) */
  --back-a:#5a3b11; --back-b:#452d0c; --back-c:#2d1d07;
  --orn:#ffdb7a;
  --g1:#51380f; --g2:#69450f; --g3:#3a270a;
}

*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN",Meiryo,sans-serif}
header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(0,0,0,.55), transparent);backdrop-filter:blur(6px)}
h1{margin:10px 12px 0;font-size:1.2rem}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px 12px 10px}
.btn{border:1px solid var(--edge);background:#10131b;color:var(--text);border-radius:12px;padding:8px 12px;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,#182042,#151d38)}
select,input{font-size:16px}
.tag{color:var(--sub)}
.wrap{max-width:1000px;margin:6px auto 28px;padding:0 12px;display:grid;gap:12px}
.board{background:var(--panel);border:1px solid var(--edge);border-radius:16px;padding:12px}
.stage{position:relative;height:calc(var(--cardH)*3.8);border:1px dashed var(--edge);border-radius:14px;background:linear-gradient(180deg,#0d1118,#0b0e15);overflow:hidden}
.row{position:absolute;left:50%;transform:translateX(-50%);display:flex;gap:12px;width:92%;justify-content:center}
.row.top{top:12%}
.row.bottom{top:58%}
.slot{width:var(--cardW);height:var(--cardH);border:1px dashed var(--edge);border-radius:12px;display:flex;align-items:center;justify-content:center;color:var(--sub);position:relative}
.slot .label{position:absolute;left:6px;top:-10px;font-size:.85rem;background:var(--panel);padding:0 6px;border-radius:6px;border:1px solid var(--edge)}

.cardEl{position:absolute;left:0;top:0;width:var(--cardW);height:var(--cardH);transform-origin:center;perspective:800px}
.cardEl .inner{
  position:relative;width:100%;height:100%;
  transform-style:preserve-3d;
  transition:transform .6s cubic-bezier(.2,.7,.2,1);
}
.face{position:absolute;inset:0;border-radius:14px;border:1px solid var(--edge);
  box-shadow:0 10px 30px #0008, inset 0 0 0 1px #ffffff10; backface-visibility:hidden}

/* ----- Lux back (ornamented) ----- */
.back{
  /* deep gradient + subtle pattern */
  background:
    radial-gradient(120px 80px at 70% 25%, #ffffff0a, transparent 60%),
    linear-gradient(135deg,var(--g1),var(--g2) 45%,var(--g3) 80%),
    repeating-linear-gradient(45deg, #ffffff06 0 6px, #00000000 6px 12px);
  display:flex;align-items:center;justify-content:center;letter-spacing:.12em;
  color:var(--orn); font-weight:800;
  position:relative; overflow:hidden;
}
/* gilded frame */
.back::before{
  content:""; position:absolute; inset:6px; border-radius:12px;
  background:linear-gradient(135deg,#ffffff15,#0000), radial-gradient(120px 60px at 20% 20%, #ffffff15, #0000 60%);
  box-shadow:inset 0 0 0 1px #ffffff1f, 0 0 0 1px #0003;
}
/* shine sweep on flip */
.back::after{
  content:""; position:absolute; inset:-20%; transform:skewX(-20deg) translateX(-140%);
  background:linear-gradient(90deg, #ffffff00, #ffffff22 35%, #ffffff00);
  filter:blur(1px);
}
.cardEl.glow .back::after{ animation:shine .7s ease .1s both }
@keyframes shine{
  to{ transform:skewX(-20deg) translateX(140%); }
}

/* ----- Front (rank & suit) ----- */
.front{
  transform:rotateY(180deg); background:var(--front); color:var(--frontText);
  background-image:
    radial-gradient(120px 80px at 30% 20%, #00000006, transparent 60%),
    linear-gradient(180deg, #ffffff, #f8f8f8);
}
.rank{position:absolute;left:8px;top:6px;font-weight:800}
.suit{position:absolute;right:8px;bottom:6px;font-size:22px}
.center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
.center svg{width:54%;height:54%}
.red{color:#c62828;fill:#c62828}.black{color:#111;fill:#111}

/* Flip animation state */
.is-flipped{ transform:rotateY(180deg) }

.helper{color:var(--sub);font-size:.92rem;margin-top:8px}
.out{white-space:pre-wrap;background:#0f0f14;border:1px dashed var(--edge);border-radius:14px;padding:12px;min-height:120px}
@keyframes deal{from{transform:translate(0,0) scale(.96) rotate(-2deg);opacity:.0}to{opacity:1}}
.deal{animation:deal .35s ease}
.small{font-size:.88rem;color:var(--sub)}
footer{color:var(--sub);text-align:center;margin:14px 0}
@media (max-width:420px){ :root{--cardW:78px;--cardH:112px} }
</style>
</head>
<body>
<header>
  <h1>ç¥ã€…ã®å·¡è·¯ â€“ The Divine Cycle Pro</h1>
  <div class="toolbar">
    <label class="tag"><b>ãƒ¢ãƒ¼ãƒ‰:</b>
      <select id="spreadSel">
        <option value="tarot5">ã‚¿ãƒ­ãƒƒãƒˆ5æšï¼ˆéå»/ç¾åœ¨/æœªæ¥/éšœå®³/åŠ©è¨€ï¼‰</option>
        <option value="poker3">ãƒˆãƒ©ãƒ³ãƒ—3æšï¼ˆéå»/ç¾åœ¨/æœªæ¥ï¼‰</option>
      </select>
    </label>

    <button class="btn primary" id="btnDeal">ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å ã†</button>
    <button class="btn" id="btnFlip">å…¨ã¦ã‚ãã‚‹/æˆ»ã™</button>
    <button class="btn" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>

    <label class="tag">ãƒ†ãƒ¼ãƒ:
      <select id="themeSel">
        <option value="night">å¤œï¼ˆãƒ€ãƒ¼ã‚¯ï¼‰</option>
        <option value="gold">é‡‘ç®”ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‰ï¼‰</option>
      </select>
    </label>

    <label class="tag">éŸ³:<input type="checkbox" id="snd" checked>
      <input type="range" id="vol" min="0" max="100" value="55"></label>
    <label class="tag">æŒ¯å‹•:<input type="checkbox" id="vib" checked></label>
  </div>
</header>

<div class="wrap">
  <div class="board">
    <div class="stage" id="stage">
      <div class="row top" id="rowTop">
        <div class="slot" data-pos="past"><div class="label">éå»</div></div>
        <div class="slot" data-pos="present"><div class="label">ç¾åœ¨</div></div>
        <div class="slot" data-pos="future"><div class="label">æœªæ¥</div></div>
      </div>
      <div class="row bottom" id="rowBottom">
        <div class="slot" data-pos="obstacle"><div class="label">éšœå®³</div></div>
        <div class="slot" data-pos="advice"><div class="label">åŠ©è¨€</div></div>
      </div>
    </div>
    <div class="helper">â‘ ã€Œã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å ã†ã€â†’ â‘¡ å„ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã§åè»¢ï¼ˆé•·æŠ¼ã—ã§æ„å‘³è¡¨ç¤ºï¼‰</div>
  </div>

  <div class="board">
    <h3 style="margin:.2rem 0 .6rem">çµæœ / Narrative</h3>
    <div class="out" id="out"></div>
    <div class="small" id="status"></div>
  </div>
</div>

<footer class="small">Â© Divine Cycle</footer>

<script>
/* ====== Audio / Vibration ====== */
let audioCtx=null;
function ensureAudio(){ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } }
function gainVal(){ const v=Number(vol.value)/100; return Math.max(0.0001, v*(snd.checked?1:0)); }
function beep(freq=520,time=0.06,type='triangle'){ if(!audioCtx||gainVal()<=0) return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=gainVal();
  o.connect(g).connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(), time*1000);
}
function vibe(ms=22){ if(vib.checked && navigator.vibrate) navigator.vibrate(ms); }

/* ====== Data ====== */
const SUITS=['â™ ','â™¥','â™¦','â™£'];
const RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const PLACE={'â™ ':'å†¥ç•Œã®é–€','â™¥':'è–ãªã‚‹æ³‰','â™¦':'é»„é‡‘ã®ç¥æ®¿','â™£':'ä¸–ç•Œæ¨¹ã®æ'};
const RANK_MYTH={'A':'å¤©åœ°å‰µé€ ã®å…‰','2':'åŒå­ç¥ã®èª¿å’Œ','3':'ä¸‰å¥³ç¥ã®å¾´ã—','4':'å››æ–¹å®ˆè­·ã®åŸºç›¤','5':'è‹±é›„ã®è©¦ç·´','6':'å¥‘ç´„ã¨èª¿å’Œ','7':'ç¥ç§˜ã®å°å°','8':'è¼ªå»»ã¨å› æœ','9':'çµ‚æœ«ã¨å†ç”Ÿ','10':'ç¥ç¥­ã¨æ–°å‘¨æœŸ','J':'æ¡ˆå†…äººã®å°ã','Q':'å¥³ç¥ã®åŠ è­·','K':'å¤§ç¥ã®è£å®š'};

function buildDeck(){
  const d=[]; for(const s of SUITS) for(const r of RANKS) d.push({type:'card', suit:s, rank:r});
  d.push({type:'joker', color:'R'}); d.push({type:'joker', color:'B'}); return d;
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; } return a; }
function colorOf(s){ return (s==='â™¥'||s==='â™¦')?'red':'black'; }
function meaning(card){
  if(card.type==='card'){ return `${card.suit}${card.rank}ï¼š${PLACE[card.suit]}ï¼${RANK_MYTH[card.rank]}`; }
  return (card.color==='R')?'èµ¤ğŸƒï¼šé‹å‘½ã®å¥³ç¥ãŒç³¸ã‚’æ“ã‚‹':'é»’ğŸƒï¼šãƒˆãƒªãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãŒç§©åºã‚’æºã‚‰ã™';
}

/* ====== DOM ====== */
const stage = document.getElementById('stage');
const rowTop = document.getElementById('rowTop');
const rowBottom = document.getElementById('rowBottom');
const out = document.getElementById('out');
const statusEl = document.getElementById('status');
const btnDeal = document.getElementById('btnDeal');
const btnFlip = document.getElementById('btnFlip');
const btnReset = document.getElementById('btnReset');
const themeSel = document.getElementById('themeSel');
const snd = document.getElementById('snd');
const vib = document.getElementById('vib');
const vol = document.getElementById('vol');
const spreadSel = document.getElementById('spreadSel');

/* ====== Helpers ====== */
function svgSuit(suit, cls){
  const div=document.createElement('div');
  div.innerHTML=`<svg viewBox="0 0 100 100" aria-hidden="true"><text x="50" y="70" text-anchor="middle" font-size="80" class="${cls}">${suit}</text></svg>`;
  return div.firstChild;
}
function makeCardEl(card){
  const el=document.createElement('div'); el.className='cardEl deal';
  const inner=document.createElement('div'); inner.className='inner';
  const back=document.createElement('div'); back.className='face back'; back.textContent='DIVINE';
  const front=document.createElement('div'); front.className='face front';

  if(card.type==='card'){
    const rank=document.createElement('div'); rank.className='rank '+(colorOf(card.suit)==='red'?'red':'black'); rank.textContent=card.rank;
    const suit=document.createElement('div'); suit.className='suit '+(colorOf(card.suit)==='red'?'red':'black'); suit.textContent=card.suit;
    const center=document.createElement('div'); center.className='center';
    center.appendChild(svgSuit(card.suit,(colorOf(card.suit)==='red'?'red':'black')));
    front.append(rank,suit,center);
  }else{
    const center=document.createElement('div'); center.className='center'; center.textContent=(card.color==='R')?'èµ¤ğŸƒ':'é»’ğŸƒ';
    front.appendChild(center);
  }

  inner.append(back,front); el.appendChild(inner);

  const flip = ()=>{
    if(!audioCtx) ensureAudio();
    inner.classList.toggle('is-flipped');     // 3D å›è»¢
    el.classList.add('glow');                 // è£é¢ã‚·ãƒ£ã‚¤ãƒ³
    setTimeout(()=> el.classList.remove('glow'), 750);
    beep(540,0.06,'triangle'); vibe(18);
  };
  el.addEventListener('click', flip);
  el.addEventListener('touchend', (e)=>{ e.preventDefault(); flip(); }, {passive:false});

  // é•·æŠ¼ã—ï¼šæ„å‘³ãƒãƒƒãƒ—
  let pressTimer=null;
  el.addEventListener('touchstart', ()=>{ pressTimer=setTimeout(()=>{ alert(meaning(card)); },420); },{passive:true});
  el.addEventListener('touchend', ()=> clearTimeout(pressTimer), {passive:true});

  return el;
}
function placeCard(el, slot){
  stage.appendChild(el);
  const sr=stage.getBoundingClientRect(), cr=slot.getBoundingClientRect();
  el.style.transform=`translate(${cr.left-sr.left}px, ${cr.top-sr.top}px)`;
}
function resetBoard(){
  [...stage.querySelectorAll('.cardEl')].forEach(e=>e.remove());
  [...stage.querySelectorAll('.slot')].forEach(s=> s.style.visibility='visible');
  out.textContent=''; statusEl.textContent='';
}

/* ====== Layout / Theme ====== */
function applySpreadLayout(kind){
  if (kind === 'poker3') { rowTop.style.display='flex'; rowBottom.style.display='none'; }
  else { rowTop.style.display='flex'; rowBottom.style.display='flex'; }
}
function applyTheme(v){ document.documentElement.classList.toggle('gold', v==='gold'); }

/* ====== Actions ====== */
btnReset.addEventListener('click', resetBoard);

btnDeal.addEventListener('click', ()=>{
  ensureAudio();
  resetBoard();
  const kind = spreadSel.value;
  const deck = shuffle(buildDeck());

  if (kind === 'poker3') {
    const picks = deck.slice(0, 3);
    const slots = [...rowTop.querySelectorAll('.slot')];
    let texts = [];
    picks.forEach((card, i) => {
      const el = makeCardEl(card);
      placeCard(el, slots[i]);
      slots[i].style.visibility = 'hidden';
      texts.push(`${['éå»','ç¾åœ¨','æœªæ¥'][i]}ï¼š${meaning(card)}`);
    });
    out.textContent = texts.join('\n');
    statusEl.textContent = 'ãƒˆãƒ©ãƒ³ãƒ—3æšï¼šã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã§åè»¢ã€‚';
  } else {
    const picks = deck.slice(0,5);
    const slots = [...rowTop.querySelectorAll('.slot'), ...rowBottom.querySelectorAll('.slot')];
    let texts=[];
    picks.forEach((card,i)=>{
      const el=makeCardEl(card);
      placeCard(el, slots[i]);
      slots[i].style.visibility='hidden';
      texts.push(`${['éå»','ç¾åœ¨','æœªæ¥','éšœå®³','åŠ©è¨€'][i]}ï¼š${meaning(card)}`);
    });
    out.textContent = texts.join('\n');
    statusEl.textContent = 'ã‚¿ãƒ­ãƒƒãƒˆ5æšï¼šã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã§åè»¢ã€‚é•·æŠ¼ã—ã§æ„å‘³è¡¨ç¤ºã€‚';
  }
});

let flippedAll=false;
btnFlip.addEventListener('click', ()=>{
  flippedAll=!flippedAll;
  stage.querySelectorAll('.cardEl .inner').forEach(i=> i.classList.toggle('is-flipped', flippedAll));
});

/* ====== Init ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  applyTheme(themeSel.value);
  applySpreadLayout(spreadSel.value);
});
themeSel.addEventListener('change', ()=> applyTheme(themeSel.value));
spreadSel.addEventListener('change', ()=> applySpreadLayout(spreadSel.value));

/* ====== SW ====== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js?v=3").catch(console.error);
  });
}
</script>
</body>
</html>
